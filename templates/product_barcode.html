{% extends 'base.html' %}

{% block title %}Barcode - {{ product.name }}{% endblock %}

{% block content %}
<section class="page">
  <div class="page-header no-print">
    <h2>Barcode & QR Code</h2>
    <div>
      <a href="{{ url_for('products_list') }}" class="btn">Back</a>
      <button type="button" class="btn primary" onclick="window.print()">Print</button>
    </div>
  </div>

  <div style="display:flex; gap:1rem; flex-wrap:wrap; align-items:flex-start;">
    <div style="flex: 1 1 300px;">
      <h3 style="margin-top:0;">{{ product.name }}</h3>
      <p style="margin:0.25rem 0; color:#333;">SKU: {{ product.sku or '-' }}</p>
      <p style="margin:0.25rem 0; color:#333;">Barcode: <strong>{{ product.barcode or '-' }}</strong></p>

      <div style="margin-top: 1rem; padding: 1rem; border: 1px solid #ccc; border-radius: 4px;">
        <strong style="color: #000;">Scanning Tips:</strong>
        <ul style="margin: 0.5rem 0 0 1rem; color: #333; font-size: 0.9rem;">
          <li>Use <strong>QR Code</strong> for phone/tablet camera scanning</li>
          <li>Use <strong>Barcode</strong> for USB barcode scanners</li>
          <li>Ensure good lighting when scanning</li>
        </ul>
      </div>
    </div>

    <!-- QR Code -->
    <div style="flex: 0 0 160px; border:1px solid #000; padding:1rem; background:#fff; align-self: flex-start;">
      <div style="text-align:center; font-weight:700; margin-bottom:0.5rem; color: #000; font-size: 0.9rem;">QR CODE
      </div>
      <div id="qrcode-container" style="display: flex; justify-content: center; margin: 0.5rem 0;"></div>
      <div style="text-align:center; margin-top:0.25rem; font-size: 0.8rem; color: #000;">{{ product.barcode or
        product.sku }}</div>
    </div>

    <!-- Traditional Barcode -->
    <div style="flex: 0 0 220px; border:1px solid #000; padding:1rem; background:#fff; align-self: flex-start;">
      <div style="text-align:center; font-weight:600; margin-bottom:0.25rem; font-size: 0.9rem;">{{ store.store_name }}
      </div>
      <div style="text-align:center; margin-bottom:0.25rem; font-size: 0.8rem;">{{ product.name }}</div>
      <svg id="barcode-svg" style="display: block; margin: 0 auto;"></svg>
      <div id="barcode-error"
        style="display: none; text-align: center; color: #000; padding: 0.5rem; font-size: 0.8rem;">
        Generate Failed
      </div>
      <div
        style="text-align:center; margin-top:0.25rem; font-variant-numeric: tabular-nums; font-size: 0.8rem; letter-spacing: 1px;">
        {{ product.barcode }}</div>
    </div>
  </div>
</section>

<!-- JsBarcode for traditional barcodes -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<!-- QRCode.js (Davidshimjs) - More robust browser support -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
  (function () {
    const barcodeValue = "{{ (product.barcode or product.sku or '')|e }}";
    const barcodeSvg = document.getElementById('barcode-svg');
    const barcodeError = document.getElementById('barcode-error');
    const qrcodeContainer = document.getElementById('qrcode-container');

    if (!barcodeValue) return;

    // Generate QR Code
    if (window.QRCode && qrcodeContainer) {
      try {
        qrcodeContainer.innerHTML = '';
        new QRCode(qrcodeContainer, {
          text: barcodeValue,
          width: 100,  // Small size
          height: 100, // Small size
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.M
        });
      } catch (e) {
        console.error('QR Code error:', e);
        qrcodeContainer.innerHTML = 'Error';
      }
    }

    // Generate traditional barcode
    if (window.JsBarcode && barcodeSvg) {
      // Try CODE39 first (simpler) then CODE128
      const formats = ['CODE39', 'CODE128'];
      let success = false;

      for (const format of formats) {
        try {
          JsBarcode(barcodeSvg, barcodeValue.toUpperCase(), {
            format: format,
            displayValue: false,
            fontSize: 12,
            height: 40,   // Smaller height
            margin: 2,
            width: 1.5    // Thinner bars
          });
          success = true;
          break;
        } catch (e) {
          // Continue to next format
        }
      }

      if (!success) {
        barcodeSvg.style.display = 'none';
        barcodeError.style.display = 'block';
      }
    }
  })();
</script>

<style>
  @media print {

    .no-print,
    .btn,
    .page-header {
      display: none !important;
    }

    body {
      background: white;
    }

    .page {
      margin: 0;
      padding: 0;
    }

    section {
      padding: 0;
    }
  }
</style>
{% endblock %}